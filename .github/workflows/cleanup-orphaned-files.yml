name: Cleanup Orphaned Files

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
    - cron: '0 2 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read      # é€šå¸¸ read å°±å¤Ÿäº†ï¼Œé™¤éä½ è¦æäº¤ä»£ç 
  issues: write       # å¿…é¡»ï¼šç”¨äºåˆ›å»ºå’Œç¼–è¾‘ Issue

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Run cleanup in dry-run mode
      id: dry-run
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "Environment check:"
        echo "SUPABASE_URL: ${SUPABASE_URL:0:20}..."
        echo "SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY:0:20}..."
        echo ""

        # ç¡®ä¿è„šæœ¬é»˜è®¤æ˜¯ dry-runï¼Œæˆ–è€…æ˜¾å¼æ·»åŠ å‚æ•°ï¼Œä¾‹å¦‚:
        # python scripts/cleanup_orphaned_files.py --dry-run
        python scripts/cleanup_orphaned_files.py

    - name: Upload dry-run report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cleanup-dryrun-report
        path: cleanup_report_*.json

    - name: Check for orphaned files
      id: check-orphans
      shell: bash
      run: |
        # æŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
        report_file=$(ls cleanup_report_*.json | head -1)
        
        if [ -n "$report_file" ]; then
          echo "Found report: $report_file"
          
          # ä½¿ç”¨ jq æå–å­¤å„¿æ–‡ä»¶æ•°é‡ (æ¯” python -c æ›´ç¨³å¥)
          orphaned_count=$(jq '.statistics.orphaned_files' "$report_file")
          
          echo "Orphaned count: $orphaned_count"
          
          if [ "$orphaned_count" -gt 0 ]; then
            echo "has_orphaned=true" >> $GITHUB_OUTPUT
            echo "orphaned_count=$orphaned_count" >> $GITHUB_OUTPUT
          else
            echo "has_orphaned=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "No report file found."
          echo "has_orphaned=false" >> $GITHUB_OUTPUT
        fi

    - name: Create issue for manual review
      if: steps.check-orphans.outputs.has_orphaned == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          // æŸ¥æ‰¾æŠ¥å‘Šæ–‡ä»¶
          const reportFiles = fs.readdirSync('.').filter(f => f.startsWith('cleanup_report_') && f.endsWith('.json'));

          if (reportFiles.length > 0) {
            const reportData = JSON.parse(fs.readFileSync(reportFiles[0], 'utf8'));
            const orphanedCount = reportData.statistics.orphaned_files;

            // æ ‡é¢˜
            const issueTitle = `ğŸ§¹ Orphaned Blueprint Groups Detected (${orphanedCount} groups)`;
            
            // æ„å»º Issue æ­£æ–‡
            // æ³¨æ„ï¼šè¯·ç¡®ä¿ä¸‹æ–¹ map ä¸­çš„é€»è¾‘ä¸ä½ çš„ JSON ç»“æ„åŒ¹é…
            const fileListMd = reportData.orphaned_files.map((group, i) => {
               // å‡è®¾ group æ˜¯å¯¹è±¡ï¼Œè¿™é‡Œå°è¯•åˆ—å‡ºé™¤ blueprint_id å¤–çš„å±æ€§æ•°ä½œä¸ºæ–‡ä»¶æ•°
               const fileCount = Object.values(group).filter(v => v !== group.blueprint_id && v).length;
               return `${i + 1}. \`${group.blueprint_id}\` - ${fileCount} ä¸ªæ–‡ä»¶`;
            }).join('\n');

            const issueBody = `
            ## æ¸…ç†æŠ¥å‘Š

            **ç”Ÿæˆæ—¶é—´**: ${reportData.cleanup_timestamp}
            **æ‰«æè“å›¾ç»„æ€»æ•°**: ${reportData.statistics.total_files_scanned}
            **æœ‰æ•ˆè“å›¾ç»„**: ${reportData.statistics.valid_files}
            **å­¤å„¿è“å›¾ç»„**: ${reportData.statistics.orphaned_files}

            ## æ¸…ç†ç­–ç•¥è¯´æ˜

            é»˜è®¤ä½¿ç”¨**å®‰å…¨ç§»åŠ¨ç­–ç•¥**ï¼š
            - ğŸ“¦ ç§»åŠ¨åˆ° \`.cleanup\` ç›®å½•è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
            - ğŸ”„ è‡ªåŠ¨é‡æ–°ç”Ÿæˆ index.json
            - ğŸ“‹ ä¿ç•™Gitå†å²è®°å½•
            - âš ï¸ å¯ä»¥ä» \`.cleanup\` ç›®å½•æ¢å¤

            ## å­¤å„¿è“å›¾ç»„åˆ—è¡¨

            ${fileListMd}

            ## å¤„ç†é€‰é¡¹

            1. **è‡ªåŠ¨ç§»åŠ¨**: ä½¿ç”¨å®‰å…¨ç­–ç•¥ç§»åŠ¨åˆ° .cleanup ç›®å½•
            2. **æ‰‹åŠ¨å¤„ç†**: è¿è¡Œæ‰‹åŠ¨æ¸…ç†å·¥ä½œæµç¨‹
            3. **æ£€æŸ¥åå¤„ç†**: ç¡®è®¤æ— è¯¯åå†æ¸…ç†

            ---

            *æ­¤æŠ¥å‘Šç”±å®šæœŸæ¸…ç†ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ | ä½¿ç”¨ \`--auto-delete\` é€‰é¡¹è¿›è¡Œè‡ªåŠ¨æ¸…ç†*
            `;

            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸å…³ issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['orphaned-blueprints'],
              state: 'open' // åªæŸ¥æ‰¾å¼€å¯çš„ issue
            });

            if (issues.length === 0) {
              // åˆ›å»ºæ–° issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['orphaned-blueprints', 'maintenance']
              });
              console.log("Created new issue.");
            } else {
              // æ›´æ–°ç°æœ‰ issue çš„è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: issueBody
              });
              console.log(`Commented on existing issue #${issues[0].number}.`);
            }
          }