name: Cleanup Orphaned Files

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
    - cron: '0 2 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Run cleanup in dry-run mode
      id: dry-run
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        python scripts/cleanup_orphaned_files.py

    - name: Upload dry-run report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cleanup-dryrun-report
        path: cleanup_report_*.json

    - name: Check if auto-cleanup should run
      id: check-auto
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å­¤å„¿æ–‡ä»¶éœ€è¦æ¸…ç†
        if [ -f "cleanup_report_*.json" ]; then
          report_file=$(ls cleanup_report_*.json | head -1)
          orphaned_count=$(python -c "
          import json
          import glob
          reports = glob.glob('cleanup_report_*.json')
          if reports:
              with open(reports[0]) as f:
                  data = json.load(f)
                  print(data['statistics']['orphaned_files'])
          ")

          if [ "$orphaned_count" -gt 0 ]; then
            echo "has_orphaned=true" >> $GITHUB_OUTPUT
            echo "orphaned_count=$orphaned_count" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Create issue for manual review
      if: steps.check-auto.outputs.has_orphaned == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportFiles = fs.readdirSync('.').filter(f => f.startsWith('cleanup_report_') && f.endsWith('.json'));

          if (reportFiles.length > 0) {
            const reportData = JSON.parse(fs.readFileSync(reportFiles[0], 'utf8'));
            const orphanedCount = reportData.statistics.orphaned_files;

            const issueTitle = `ğŸ§¹ Orphaned Blueprint Groups Detected (${orphanedCount} groups)`;
            const issueBody = `
## æ¸…ç†æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: ${reportData.cleanup_timestamp}
**æ‰«æè“å›¾ç»„æ€»æ•°**: ${reportData.statistics.total_files_scanned}
**æœ‰æ•ˆè“å›¾ç»„**: ${reportData.statistics.valid_files}
**å­¤å„¿è“å›¾ç»„**: ${reportData.statistics.orphaned_files}

## æ¸…ç†ç­–ç•¥è¯´æ˜

é»˜è®¤ä½¿ç”¨**å®‰å…¨ç§»åŠ¨ç­–ç•¥**ï¼š
- ğŸ“¦ ç§»åŠ¨åˆ° `.cleanup` ç›®å½•è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
- ğŸ”„ è‡ªåŠ¨é‡æ–°ç”Ÿæˆ index.json
- ğŸ“‹ ä¿ç•™Gitå†å²è®°å½•
- âš ï¸ å¯ä»¥ä» `.cleanup` ç›®å½•æ¢å¤

## å­¤å„¿è“å›¾ç»„åˆ—è¡¨

${reportData.orphaned_files.map((group, i) =>
  `${i + 1}. \`${group.blueprint_id}\` - ${Object.values(group).filter(v => v !== group.blueprint_id && v).length} ä¸ªæ–‡ä»¶`
).join('\n')}

## å¤„ç†é€‰é¡¹

1. **è‡ªåŠ¨ç§»åŠ¨**: ä½¿ç”¨å®‰å…¨ç­–ç•¥ç§»åŠ¨åˆ°.cleanupç›®å½•
2. **æ‰‹åŠ¨å¤„ç†**: è¿è¡Œæ‰‹åŠ¨æ¸…ç†å·¥ä½œæµç¨‹
3. **æ£€æŸ¥åå¤„ç†**: ç¡®è®¤æ— è¯¯åå†æ¸…ç†

---

*æ­¤æŠ¥å‘Šç”±å®šæœŸæ¸…ç†ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ | ä½¿ç”¨ \`--auto-delete\` é€‰é¡¹è¿›è¡Œè‡ªåŠ¨æ¸…ç†*
            `;

            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸å…³issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['orphaned-blueprints']
            });

            if (issues.length === 0) {
              // åˆ›å»ºæ–°issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['orphaned-blueprints', 'maintenance']
              });
            } else {
              // æ›´æ–°ç°æœ‰issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: issueBody
              });
            }
          }

    - name: Check if auto-cleanup should run
      id: check-auto
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å­¤å„¿æ–‡ä»¶éœ€è¦æ¸…ç†
        if [ -f "cleanup_report_*.json" ]; then
          report_file=$(ls cleanup_report_*.json | head -1)
          orphaned_count=$(python -c "
          import json
          import glob
          reports = glob.glob('cleanup_report_*.json')
          if reports:
              with open(reports[0]) as f:
                  data = json.load(f)
                  print(data['statistics']['orphaned_files'])
          ")

          if [ "$orphaned_count" -gt 0 ]; then
            echo "has_orphaned=true" >> $GITHUB_OUTPUT
            echo "orphaned_count=$orphaned_count" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Create issue for manual review
      if: steps.check-auto.outputs.has_orphaned == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportFiles = fs.readdirSync('.').filter(f => f.startsWith('cleanup_report_') && f.endsWith('.json'));

          if (reportFiles.length > 0) {
            const reportData = JSON.parse(fs.readFileSync(reportFiles[0], 'utf8'));
            const orphanedCount = reportData.statistics.orphaned_files;

            const issueTitle = `ğŸ§¹ Orphaned Files Detected (${orphanedCount} files)`;
            const issueBody = `
## æ¸…ç†æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: ${reportData.cleanup_timestamp}
**æ‰«ææ–‡ä»¶æ€»æ•°**: ${reportData.statistics.total_files_scanned}
**æœ‰æ•ˆæ–‡ä»¶**: ${reportData.statistics.valid_files}
**å­¤å„¿æ–‡ä»¶**: ${reportData.statistics.orphaned_files}

## å­¤å„¿æ–‡ä»¶åˆ—è¡¨

${reportData.orphaned_files.map((file, i) =>
  `${i + 1}. \`${file.file}\` (ID: \`${file.blueprint_id}\`)`
).join('\n')}

## å¤„ç†å»ºè®®

1. æ£€æŸ¥è¿™äº›æ–‡ä»¶æ˜¯å¦éœ€è¦ä¿ç•™
2. å¦‚éœ€æ¸…ç†ï¼Œè¯·è¿è¡Œæ‰‹åŠ¨æ¸…ç†å·¥ä½œæµç¨‹
3. æˆ–è€…æˆæƒè‡ªåŠ¨æ¸…ç†ï¼ˆéœ€è¦è°¨æ…æ“ä½œï¼‰

---
*æ­¤æŠ¥å‘Šç”±å®šæœŸæ¸…ç†ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ*
            `;

            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸å…³issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['orphaned-files']
            });

            if (issues.length === 0) {
              // åˆ›å»ºæ–°issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['orphaned-files', 'maintenance']
              });
            } else {
              // æ›´æ–°ç°æœ‰issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: issueBody
              });
            }
          }