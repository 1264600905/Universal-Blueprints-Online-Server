name: Manual Cleanup Orphaned Files

on:
  workflow_dispatch:
    inputs:
      auto_delete:
        description: 'è‡ªåŠ¨åˆ é™¤å­¤å„¿æ–‡ä»¶ (å±é™©æ“ä½œ!)'
        required: true
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'

permissions:
  contents: write

jobs:
  manual-cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Show configuration
      run: |
        echo "Auto delete: ${{ github.event.inputs.auto_delete }}"
        echo "This will move orphaned files to .cleanup directory (safe strategy)!"
        echo "Make sure you have reviewed the latest cleanup report first."

    - name: Run manual cleanup
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        if [ "${{ github.event.inputs.auto_delete }}" = "true" ]; then
          echo "ğŸš¨ æ‰§è¡Œè‡ªåŠ¨ç§»åŠ¨æ¨¡å¼ï¼ˆå®‰å…¨ç­–ç•¥ï¼‰"
          python scripts/cleanup_orphaned_files.py --auto-delete
        else
          echo "ğŸ“‹ æ‰§è¡Œæ‰‹åŠ¨äº¤äº’æ¨¡å¼"
          python scripts/cleanup_orphaned_files.py --execute
        fi

    - name: Upload cleanup report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: manual-cleanup-report
        path: cleanup_report_*.json

    - name: Update index.json after cleanup
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ”„ Updating index.json after cleanup..."
        python scripts/generate_index.py

    - name: Commit cleanup changes
      if: github.event.inputs.auto_delete == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬index.jsonï¼‰
        if git diff --name-only | grep -E '\.(xml|png|jpg|json)$'; then
          git add .
          git commit -m "ğŸ§¹ Auto cleanup orphaned blueprint files and update index [skip ci]"
          git pull --rebase origin main
          git push
          echo "âœ… Changes committed and pushed"
        else
          echo "â„¹ï¸  No files were deleted or index was already up to date"
        fi